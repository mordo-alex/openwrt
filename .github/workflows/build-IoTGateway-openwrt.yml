# 工作流名称
name: Build OpenWrt for My IoT Gateway

# 触发条件：允许在 GitHub 网页上手动触发
on:
  workflow_dispatch:

# 任务
jobs:
  build:
    # 使用最新的 Ubuntu 虚拟机
    runs-on: ubuntu-latest

    steps:
      # 步骤1：检出您的代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：安装编译所需的依赖
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev rsync unzip zlib1g-dev file wget

      # 步骤3：更新并安装 OpenWrt 的 feeds 软件包
      - name: Update and install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 步骤4：加载您的自定义配置文件
      - name: Load custom configuration
        run: |
          mv IoT-gateway.config .config
          make defconfig

      # 步骤5：下载所有软件包的源码
      - name: Download package sources
        run: make download -j$(nproc)

      # 步骤6：开始编译固件
      - name: Build firmware
        run: make -j$(nproc) V=s

      # 步骤7：上传编译好的固件作为“产物” (Artifact)
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-firmware-my-iot-gateway
          path: bin/targets/ramips/mt76x8/*sysupgrade.bin
      # (前面是 "Build firmware" 和 "Upload firmware artifact" 的步骤)
      # ...
    
      # 步骤8：准备发布所需的环境变量
      - name: Prepare Release Environment
        id: release_env
        run: |
          echo "FILE_DATE=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
          echo "DEVICE_NAME=My-IoT-Gateway" >> $GITHUB_ENV

      # 步骤9：创建 Release 并上传固件
      - name: Upload Firmware to Release
        uses: softprops/action-gh-release@v2
        with:
          # 使用唯一的日期和ID创建 Release 标签 (tag)
          tag_name: ${{ github.run_id }}-${{ env.DEVICE_NAME }}-${{ env.FILE_DATE }}
          # Release 的标题
          name: Auto Release - ${{ env.DEVICE_NAME }} - ${{ env.FILE_DATE }}
          # Release 的描述内容
          body: |
            This is an automated release of the OpenWrt firmware.
            - Device: ${{ env.DEVICE_NAME }}
            - Date: ${{ env.FILE_DATE }}
          # 要上传的文件 (使用通配符匹配)
          files: bin/targets/ramips/mt76x8/*sysupgrade.bin
